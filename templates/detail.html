<!doctype html>
<html lang="{{ strings.lang }}">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ item.title }}</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github.min.css" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
    /* Life Status Bar overrides for light theme detail page */
    .life-status.detail-mode {
      background: transparent;
      border: none;
      padding: 0;
      margin-bottom: 24px;
      margin-top: -12px;
    }

    .life-status.detail-mode .life-bar {
      background: rgba(0, 0, 0, 0.06);
      height: 6px;
    }

    .life-status.detail-mode .life-remaining {
      color: #64748b;
      font-size: 13px;
    }

    .life-status.detail-mode .life-icon {
      color: #94a3b8;
    }
  </style>
</head>

<body>
  <main class="container">

    <div class="title-row">
      <h1>{{ item.title }}</h1>
      <a class="btn btn-secondary" href="/">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path
            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
        </svg>
        {{ strings.detail_new_paste }}
      </a>
    </div>
    <div class="meta-info">


      <div class="meta-item" title="{{ strings.label_language }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span id="language-label-val">{{ language_label }}</span>
      </div>

      {% if remaining_views.is_some() %}
      <div class="meta-item" title="{{ strings.label_burn }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <span>{{ remaining_views.as_ref().unwrap() }}</span>
      </div>
      {% endif %}
    </div>

    <!-- Life Status Bar -->
    <div class="life-status detail-mode" id="lifeStatus" data-created="{{ item.created_at }}"
      data-expires="{{ item.expires_at }}" data-duration="{{ item.original_duration }}">
      <div class="life-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="life-bar-container">
        <div class="life-bar">
          <div class="life-bar-fill"></div>
        </div>
      </div>
      <div class="life-text">
        <span class="life-remaining"></span>
      </div>
    </div>
    <div class="detail-actions">
      {% if item.is_public && item.max_views.is_none() %}
      <button class="btn btn-primary" hx-post="/p/{{ token }}/renew" hx-swap="outerHTML" id="renew-btn" style="display: none;">
        üïØÔ∏è {{ strings.button_renew }}
      </button>
      {% endif %}
      <a class="btn btn-secondary" href="/?fork={{ token }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        {{ strings.button_fork }}
      </a>
      <button class="btn btn-secondary" type="button" id="copy-btn" data-label="{{ strings.detail_copy }}"
        data-copied="{{ strings.detail_copy_done }}">
        {{ strings.detail_copy }}
      </button>
      <a class="btn btn-secondary" href="/r/{{ token }}">{{ strings.detail_raw }}</a>
    </div>
    <div class="code-wrapper">
      <div class="line-numbers" id="line-numbers"></div>
      <pre
        class="paste-content"><code id="paste-content" data-language="{{ item.language }}">{{ item.content }}</code></pre>
    </div>

    <footer class="footer">
      <div class="language-selector">
        <a href="/p/{{ token }}?lang=en" class="lang-link">English</a>
        <span class="separator">/</span>
        <a href="/p/{{ token }}?lang=zh" class="lang-link">‰∏≠Êñá</a>
      </div>
    </footer>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
  <script>
    const copyButton = document.getElementById("copy-btn");
    const content = document.getElementById("paste-content");
    const lineNumbers = document.getElementById("line-numbers");

    if (content) {
      const source = content.textContent || "";
      if (lineNumbers) {
        const linesCount = source.split(/\r\n|\r|\n/).length;
        let nums = "";
        for (let i = 1; i <= linesCount; i++) {
          nums += i + "\n";
        }
        lineNumbers.textContent = nums;
      }

      const language = content.dataset.language || "auto";
      if (window.hljs) {
        if (language === "auto") {
          const result = window.hljs.highlightAuto(source);
          content.innerHTML = result.value;
          content.classList.add("hljs");
          if (result.language) {
            const langLabel = document.getElementById("language-label-val");
            if (langLabel) {
              langLabel.textContent += " (" + result.language + ")";
            }
          }
        } else if (window.hljs.getLanguage(language)) {
          const result = window.hljs.highlight(source, { language });
          content.innerHTML = result.value;
          content.classList.add("hljs");
        } else {
          const result = window.hljs.highlightAuto(source);
          content.innerHTML = result.value;
          content.classList.add("hljs");
        }
      }
    }

    if (copyButton && content) {
      copyButton.addEventListener("click", async () => {
        const text = content.textContent || "";
        try {
          await navigator.clipboard.writeText(text);
          copyButton.textContent = copyButton.dataset.copied || copyButton.textContent;
          setTimeout(() => {
            copyButton.textContent = copyButton.dataset.label || copyButton.textContent;
          }, 1500);
        } catch {
          copyButton.textContent = copyButton.dataset.label || copyButton.textContent;
        }
      });
    }

    // Life Status Logic
    const lifeStatus = document.getElementById('lifeStatus');
    if (lifeStatus) {
      const LIFE_STRINGS = {
        vibrant: "{{ strings.life_vibrant }}",
        fading: "{{ strings.life_fading }}",
        dying: "{{ strings.life_dying }}",
        remaining: "{{ strings.life_remaining }}"
      };

      const DURATION_STRINGS = {
        seconds: "{{ strings.duration_seconds }}",
        minutes: "{{ strings.duration_minutes }}",
        hours: "{{ strings.duration_hours }}",
        days: "{{ strings.duration_days }}",
        expired: "{{ strings.duration_expired }}"
      };

      function formatDuration(seconds) {
        if (seconds <= 0) return DURATION_STRINGS.expired;
        if (seconds < 60) return DURATION_STRINGS.seconds.replace('{}', Math.floor(seconds));
        if (seconds < 3600) return DURATION_STRINGS.minutes.replace('{}', Math.floor(seconds / 60));
        if (seconds < 86400) return DURATION_STRINGS.hours.replace('{}', Math.floor(seconds / 3600));
        return DURATION_STRINGS.days.replace('{}', Math.floor(seconds / 86400));
      }

      function getLifePercentage(expiresAt, originalDuration) {
        const now = Math.floor(Date.now() / 1000);
        const remaining = expiresAt - now;
        if (remaining <= 0) return 0;
        if (originalDuration <= 0) return 0;
        return Math.min(100, (remaining / originalDuration) * 100);
      }

      function getLifeStatus(percentage) {
        if (percentage > 50) return { status: 'vibrant', text: LIFE_STRINGS.vibrant };
        if (percentage > 25) return { status: 'fading', text: LIFE_STRINGS.fading };
        return { status: 'dying', text: LIFE_STRINGS.dying };
      }

      function updateLifeStatus() {
        const createdAt = parseInt(lifeStatus.dataset.created);
        const expiresAt = parseInt(lifeStatus.dataset.expires);
        const originalDuration = parseInt(lifeStatus.dataset.duration || (expiresAt - createdAt));
        const now = Math.floor(Date.now() / 1000);
        const remaining = expiresAt - now;
        const percentage = getLifePercentage(expiresAt, originalDuration);
        const lifeInfo = getLifeStatus(percentage);

        const lifeBarFill = lifeStatus.querySelector('.life-bar-fill');
        const lifeText = lifeStatus.querySelector('.life-remaining');
        const renewBtn = document.getElementById('renew-btn');

        if (lifeBarFill) {
          lifeBarFill.style.width = percentage + '%';
          lifeBarFill.dataset.status = lifeInfo.status;
        }

        if (lifeText) {
          lifeText.textContent = formatDuration(remaining);
        }

        if (renewBtn) {
          if (remaining < (originalDuration / 2)) {
            renewBtn.style.display = 'inline-flex';
          } else {
            renewBtn.style.display = 'none';
          }
        }
      }

      // Listen for the 'renewed' event from HTMX
      document.body.addEventListener('renewed', (evt) => {
        if (evt.detail && evt.detail.expires) {
          lifeStatus.dataset.expires = evt.detail.expires;
          updateLifeStatus();
        }
      });

      updateLifeStatus();
      setInterval(updateLifeStatus, 1000); // Live update every second for detail page
    }
  </script>
</body>

</html>