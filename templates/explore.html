<!doctype html>
<html lang="{{ strings.lang }}">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>{{ strings.explore_title }} - {{ strings.app_title }}</title>
    <link rel="stylesheet" href="/assets/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Header:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>

<body class="explore-page">
    <!-- Explore Container -->
    <div class="explore-container" id="exploreContainer">
        {% if total == 0 %}
        <!-- Empty State -->
        <div class="explore-empty">
            <div class="explore-empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 15h8"></path>
                    <circle cx="9" cy="9" r="1"></circle>
                    <circle cx="15" cy="9" r="1"></circle>
                </svg>
            </div>
            <h2>{{ strings.explore_empty }}</h2>
            <a href="/" class="btn btn-primary">{{ strings.button_create }}</a>
        </div>
        {% else %}
        <!-- Slides Container -->
        <div class="explore-slides" id="exploreSlides">
            {% for paste in pastes %}
            <div class="explore-slide" data-index="{{ loop.index0 }}" data-token="{{ paste.token }}"
                data-created="{{ paste.created_at }}" data-expires="{{ paste.expires_at }}" data-duration="{{ paste.original_duration }}">
                <div class="slide-content">
                    <!-- Life Aura Glow Effect -->
                    <div class="life-aura"></div>

                    <div class="slide-header">
                        <h1 class="slide-title">{{ paste.title }}</h1>
                        <a href="/p/{{ paste.token }}" class="slide-link btn btn-secondary" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                    </div>
                    <div class="slide-code-wrapper">
                        <pre
                            class="slide-code"><code class="language-{{ paste.language }}">{{ paste.content }}</code></pre>
                    </div>

                    <!-- Life Status Bar -->
                    <div class="life-status">
                        <div class="life-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="life-bar-container">
                            <div class="life-bar">
                                <div class="life-bar-fill"></div>
                            </div>
                        </div>
                        <div class="life-text">
                            <span class="life-remaining"></span>
                        </div>
                        <button class="btn btn-primary renew-btn" hx-post="/p/{{ paste.token }}/renew" hx-swap="outerHTML" style="display: none; height: 28px; padding: 0 10px; font-size: 12px; margin-left: 10px;">
                          üïØÔ∏è {{ strings.button_renew }}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Navigation Controls -->
        <div class="explore-nav">
            <button class="nav-btn nav-prev" id="navPrev" title="{{ strings.explore_nav_prev }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
            <button class="nav-btn nav-next" id="navNext" title="{{ strings.explore_nav_next }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </div>

        <!-- Progress Indicator -->
        <div class="explore-progress">
            <span class="progress-current" id="progressCurrent">1</span>
            <span class="progress-separator">/</span>
            <span class="progress-total" id="progressTotal">{{ total }}</span>
        </div>

        <!-- Swipe Hint (shown briefly) -->
        <div class="explore-hint" id="exploreHint">
            {{ strings.explore_swipe_hint }}
        </div>
        {% endif %}
    </div>

    <!-- Home Button -->
    <a href="/" class="explore-home" title="{{ strings.detail_new_paste }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </a>

    <script>
        // Life Status Configuration
        const NOW_TS = {{ now_ts }};
        const MAX_EXPIRES_SECS = {{ max_expires_secs }};

        // i18n strings
        const LIFE_STRINGS = {
            vibrant: "{{ strings.life_vibrant }}",
            fading: "{{ strings.life_fading }}",
            dying: "{{ strings.life_dying }}",
            remaining: "{{ strings.life_remaining }}"
        };

        // Duration formatting strings (reuse from locale)
        const DURATION_STRINGS = {
            seconds: "{{ strings.duration_seconds }}",
            minutes: "{{ strings.duration_minutes }}",
            hours: "{{ strings.duration_hours }}",
            days: "{{ strings.duration_days }}",
            expired: "{{ strings.duration_expired }}"
        };

        function formatDuration(seconds) {
            if (seconds <= 0) return DURATION_STRINGS.expired;
            if (seconds < 60) return DURATION_STRINGS.seconds.replace('{}', Math.floor(seconds));
            if (seconds < 3600) return DURATION_STRINGS.minutes.replace('{}', Math.floor(seconds / 60));
            if (seconds < 86400) return DURATION_STRINGS.hours.replace('{}', Math.floor(seconds / 3600));
            return DURATION_STRINGS.days.replace('{}', Math.floor(seconds / 86400));
        }

        function getLifePercentage(expiresAt, originalDuration) {
            const now = Math.floor(Date.now() / 1000);
            const remaining = expiresAt - now;
            if (remaining <= 0) return 0;
            if (originalDuration <= 0) return 0;
            return Math.min(100, (remaining / originalDuration) * 100);
        }

        function getLifeStatus(percentage) {
            if (percentage > 50) return { status: 'vibrant', text: LIFE_STRINGS.vibrant };
            if (percentage > 25) return { status: 'fading', text: LIFE_STRINGS.fading };
            return { status: 'dying', text: LIFE_STRINGS.dying };
        }

        function updateLifeStatus(slide) {
            const createdAt = parseInt(slide.dataset.created);
            const expiresAt = parseInt(slide.dataset.expires);
            const originalDuration = parseInt(slide.dataset.duration || (expiresAt - createdAt));
            const now = Math.floor(Date.now() / 1000);
            const remaining = expiresAt - now;
            const percentage = getLifePercentage(expiresAt, originalDuration);
            const lifeInfo = getLifeStatus(percentage);

            // Update life bar
            const lifeBarFill = slide.querySelector('.life-bar-fill');
            const lifeText = slide.querySelector('.life-remaining');
            const lifeAura = slide.querySelector('.life-aura');
            const slideContent = slide.querySelector('.slide-content');
            const renewBtn = slide.querySelector('.renew-btn');

            if (lifeBarFill) {
                lifeBarFill.style.width = percentage + '%';
                lifeBarFill.dataset.status = lifeInfo.status;
            }

            if (lifeText) {
                lifeText.textContent = formatDuration(remaining);
            }

            if (lifeAura) {
                lifeAura.dataset.status = lifeInfo.status;
            }

            if (slideContent) {
                slideContent.dataset.lifeStatus = lifeInfo.status;
            }

            if (renewBtn) {
              if (remaining < (originalDuration / 2)) {
                renewBtn.style.display = 'inline-flex';
              } else {
                renewBtn.style.display = 'none';
              }
            }

            // Adjust breathing animation speed
            const breathingSpeed = percentage > 50 ? 4 : (percentage > 25 ? 2 : 1);
            slide.style.setProperty('--breathing-duration', breathingSpeed + 's');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const slides = document.querySelectorAll('.explore-slide');
            const total = slides.length;

            if (total === 0) return;

            // Listen for the 'renewed' event from HTMX
            document.body.addEventListener('renewed', (evt) => {
              if (evt.detail && evt.detail.token && evt.detail.expires) {
                const slide = document.querySelector(`.explore-slide[data-token="${evt.detail.token}"]`);
                if (slide) {
                  slide.dataset.expires = evt.detail.expires;
                  updateLifeStatus(slide);
                }
              }
            });

            let currentIndex = 0;
            let isAnimating = false;
            let touchStartY = 0;
            let touchEndY = 0;

            const progressCurrent = document.getElementById('progressCurrent');
            const progressTotal = document.getElementById('progressTotal');
            const navPrev = document.getElementById('navPrev');
            const navNext = document.getElementById('navNext');
            const hint = document.getElementById('exploreHint');

            // Initialize all slides' life status
            slides.forEach(slide => updateLifeStatus(slide));

            // Update life status periodically
            setInterval(() => {
                slides.forEach(slide => updateLifeStatus(slide));
            }, 10000); // Every 10 seconds

            // Initialize
            updateSlides();
            highlightCode();

            // Hide hint after 3 seconds
            if (hint) {
                setTimeout(() => {
                    hint.classList.add('hidden');
                }, 3000);
            }

            function updateSlides() {
                slides.forEach((slide, index) => {
                    slide.classList.remove('active', 'prev', 'next');
                    if (index === currentIndex) {
                        slide.classList.add('active');
                    } else if (index < currentIndex) {
                        slide.classList.add('prev');
                    } else {
                        slide.classList.add('next');
                    }
                });
                progressCurrent.textContent = currentIndex + 1;

                // Update nav button states
                navPrev.classList.toggle('disabled', currentIndex === 0);
                navNext.classList.toggle('disabled', currentIndex === total - 1);
            }

            function goToSlide(index) {
                if (isAnimating) return;
                if (index < 0 || index >= total) return;

                isAnimating = true;
                currentIndex = index;
                updateSlides();

                setTimeout(() => {
                    isAnimating = false;
                    highlightCurrentSlide();
                }, 400);
            }

            function goNext() {
                if (currentIndex < total - 1) {
                    goToSlide(currentIndex + 1);
                }
            }

            function goPrev() {
                if (currentIndex > 0) {
                    goToSlide(currentIndex - 1);
                }
            }

            function highlightCode() {
                document.querySelectorAll('pre code').forEach((el) => {
                    hljs.highlightElement(el);
                });
            }

            function highlightCurrentSlide() {
                const activeSlide = slides[currentIndex];
                if (activeSlide) {
                    const code = activeSlide.querySelector('pre code');
                    if (code && !code.classList.contains('hljs')) {
                        hljs.highlightElement(code);
                    }
                }
            }

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // ESC returns to home
                    window.location.href = '/';
                } else if (e.key === 'ArrowUp' || e.key === 'k') {
                    e.preventDefault();
                    goPrev();
                } else if (e.key === 'ArrowDown' || e.key === 'j' || e.key === ' ') {
                    e.preventDefault();
                    goNext();
                }
            });

            // Button navigation
            navPrev.addEventListener('click', goPrev);
            navNext.addEventListener('click', goNext);

            // Touch swipe
            document.addEventListener('touchstart', (e) => {
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const diff = touchStartY - touchEndY;
                const threshold = 50;

                if (Math.abs(diff) > threshold) {
                    if (diff > 0) {
                        // Swipe up - go next
                        goNext();
                    } else {
                        // Swipe down - go prev
                        goPrev();
                    }
                }
            }

            // Mouse wheel
            let wheelTimeout = null;
            document.addEventListener('wheel', (e) => {
                if (wheelTimeout) return;

                wheelTimeout = setTimeout(() => {
                    wheelTimeout = null;
                }, 500);

                if (e.deltaY > 0) {
                    goNext();
                } else if (e.deltaY < 0) {
                    goPrev();
                }
            }, { passive: true });
        });
    </script>
</body>

</html>